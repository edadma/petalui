---
import { Code } from 'astro:components'

interface Props {
  title: string
  source?: string
  fn?: string
}

const { title, source, fn } = Astro.props

// Extract code from source if provided
let extractedCode = ''
if (source && fn) {
  // Find the function and extract content between <Demo> tags
  const fnRegex = new RegExp(`export function ${fn}\\s*\\([^)]*\\)\\s*\\{[\\s\\S]*?return\\s*\\(\\s*<Demo>([\\s\\S]*?)<\\/Demo>`, 'm')
  const match = source.match(fnRegex)
  if (match) {
    // Clean up the extracted code - remove leading whitespace consistently
    const lines = match[1].split('\n')
    // Find minimum indentation (ignoring empty lines)
    const minIndent = lines
      .filter(l => l.trim())
      .reduce((min, l) => {
        const indent = l.match(/^\s*/)?.[0].length ?? 0
        return Math.min(min, indent)
      }, Infinity)
    // Remove that indentation from all lines
    extractedCode = lines
      .map(l => l.slice(minIndent))
      .join('\n')
      .trim()
  }
}
---

<div class="example-card">
  <div class="example-header">
    <h3>{title}</h3>
    <button class="toggle-code" aria-label="Toggle code">
      <span>&lt;/&gt;</span>
    </button>
  </div>
  <slot name="demo" />
  <div class="example-code">
    {extractedCode ? (
      <>
        <div class="code-light"><Code code={extractedCode} lang="tsx" theme="material-theme-lighter" /></div>
        <div class="code-dark"><Code code={extractedCode} lang="tsx" theme="material-theme-darker" /></div>
      </>
    ) : (
      <slot name="code" />
    )}
  </div>
</div>

<style is:global>
  .example-card {
    break-inside: avoid;
    margin-bottom: 1.5rem;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .example-card > astro-island > div {
    margin: 0 !important;
    padding: 0 !important;
  }

  .example-card > .example-code {
    margin: 0 !important;
  }

  .example-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid var(--sl-color-gray-5);
    background: var(--sl-color-gray-6);
  }

  .example-header h3 {
    margin: 0;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .toggle-code {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    font-family: monospace;
    font-size: 0.875rem;
    color: var(--sl-color-gray-2);
    border-radius: 0.25rem;
  }

  .toggle-code:hover {
    background: var(--sl-color-gray-5);
  }

  .example-code {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
  }

  .example-card.open .example-code {
    max-height: 1000px;
  }

  .example-code .expressive-code,
  .example-code .astro-code,
  .example-code pre.astro-code {
    margin: 0 !important;
    border-radius: 0;
  }

  .example-code pre {
    border-radius: 0;
  }

  /* Theme-aware code blocks */
  .code-light,
  .code-dark {
    margin: 0;
    padding: 0;
  }
  .code-light { display: block; }
  .code-dark { display: none; }

  :root[data-theme="dark"] .code-light { display: none; }
  :root[data-theme="dark"] .code-dark { display: block; }
</style>

<script>
  document.querySelectorAll('.toggle-code').forEach(btn => {
    btn.addEventListener('click', () => {
      const card = btn.closest('.example-card')
      card?.classList.toggle('open')
    })
  })
</script>
